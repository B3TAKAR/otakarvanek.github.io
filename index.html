<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hledaƒç Jedn√°n√≠¬Æ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --blue: #1400FF;
    --black: #0a0a0a;
    --white: #ffffff;
    --grey: #888;
  }
  html { scroll-behavior: smooth; }
  body { background: var(--white); color: var(--black); font-family: 'Barlow', sans-serif; font-size: 13px; overflow-x: hidden; }
  a { text-decoration: none; color: inherit; }

  /* NAV */
  nav {
    position: fixed; top: 0; left: 0; right: 0;
    display: flex; justify-content: space-between; align-items: center;
    padding: 18px 40px;
    z-index: 200;
    background: rgba(255,255,255,0.94);
    backdrop-filter: blur(6px);
    border-bottom: 1px solid #e8e8e8;
  }
  .nav-logo { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.02em; }
  .nav-logo span { color: var(--blue); }
  .nav-back { font-size: 11px; font-weight: 500; letter-spacing: 0.2em; text-transform: uppercase; color: var(--grey); transition: color 0.2s; }
  .nav-back:hover { color: var(--blue); }

  /* HERO */
  .hero {
    padding-top: 64px; min-height: 40vh;
    display: flex; flex-direction: column; justify-content: flex-end;
    padding-bottom: 60px; padding-left: 40px; padding-right: 40px;
    border-bottom: 1px solid #eee;
    position: relative; overflow: hidden;
  }
  .hero-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: clamp(60px, 12vw, 160px);
    line-height: 0.87; letter-spacing: -0.02em;
    color: var(--blue); text-transform: uppercase;
  }
  .hero-name .reg {
    font-size: 0.32em; vertical-align: super;
    border: 0.1em solid var(--blue); border-radius: 50%;
    display: inline-flex; align-items: center; justify-content: center;
    width: 0.6em; height: 0.6em; margin-left: 6px;
  }
  .hero-sub {
    margin-top: 16px; font-size: clamp(14px, 1.8vw, 20px);
    font-weight: 300; line-height: 1.4; max-width: 500px; color: #444;
  }
  .hero-meta {
    position: absolute; top: 80px; right: 40px;
    text-align: right;
  }
  .barcode { width: 110px; height: 26px; margin-left: auto;
    background: repeating-linear-gradient(90deg,#000 0,#000 2px,transparent 2px,transparent 5px,#000 5px,#000 6px,transparent 6px,transparent 9px,#000 9px,#000 12px,transparent 12px,transparent 16px,#000 16px,#000 17px,transparent 17px,transparent 21px,#000 21px,#000 24px,transparent 24px,transparent 27px,#000 27px,#000 29px);
  }
  .barcode-label { font-size: 8px; font-weight: 700; letter-spacing: 0.3em; text-transform: uppercase; margin-top: 5px; font-family: 'Barlow Condensed', sans-serif; }
  .barcode-sub { font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--grey); margin-top: 8px; line-height: 1.6; }

  /* APP */
  .app-wrap { max-width: 1100px; margin: 0 auto; padding: 60px 40px; }

  .app-box { background: white; border: 1px solid #e0e0e0; box-shadow: 0 8px 40px rgba(0,0,0,0.06); }
  .app-header { background: #f0f0f0; padding: 12px 20px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #e0e0e0; }
  .app-live-dot { width: 8px; height: 8px; border-radius: 50%; background: #28c840; display: inline-block; box-shadow: 0 0 6px rgba(40,200,64,0.6); animation: hjpulse 2s infinite; }
  @keyframes hjpulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .app-live-label { font-size: 11px; font-weight: 500; letter-spacing: 0.15em; text-transform: uppercase; color: #666; }

  .app-form { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 16px; padding: 24px; align-items: end; border-bottom: 1px solid #eee; }
  .app-label { display: block; font-size: 10px; font-weight: 500; letter-spacing: 0.15em; text-transform: uppercase; color: var(--grey); margin-bottom: 6px; }
  .app-select { width: 100%; padding: 10px 32px 10px 12px; border: 1px solid #ddd; background: #fafafa; font-size: 13px; font-family: 'Barlow', sans-serif; color: var(--black); appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; cursor: pointer; transition: border-color 0.2s; }
  .app-select:focus { outline: none; border-color: var(--blue); }
  .app-select:disabled { opacity: 0.5; cursor: not-allowed; }
  .app-btn { padding: 11px 24px; background: var(--black); color: white; font-size: 11px; font-weight: 500; letter-spacing: 0.15em; text-transform: uppercase; border: none; cursor: pointer; white-space: nowrap; transition: background 0.2s; font-family: 'Barlow', sans-serif; height: 40px; }
  .app-btn:hover:not(:disabled) { background: var(--blue); }
  .app-btn:disabled { background: #ccc; cursor: not-allowed; }

  .app-results { padding: 24px; min-height: 180px; }
  .app-empty { text-align: center; padding: 50px 20px; font-size: 13px; color: var(--grey); letter-spacing: 0.05em; }
  .app-spinner { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 50px 20px; font-size: 13px; color: var(--grey); }
  .app-spinner::before { content: ''; display: inline-block; width: 18px; height: 18px; border: 2px solid #eee; border-top-color: var(--blue); border-radius: 50%; animation: hjspin 0.7s linear infinite; }
  @keyframes hjspin { to { transform: rotate(360deg); } }

  .app-summary { font-size: 11px; color: var(--grey); text-align: right; padding-bottom: 16px; letter-spacing: 0.08em; border-bottom: 1px solid #eee; margin-bottom: 20px; }

  .app-day-block { margin-bottom: 28px; }
  .app-day-title { font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.04em; color: var(--black); margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid var(--blue); display: flex; justify-content: space-between; align-items: center; }
  .app-day-count { font-size: 11px; font-weight: 500; letter-spacing: 0.12em; color: var(--grey); font-family: 'Barlow', sans-serif; }
  .app-no-hearings { font-size: 12px; color: #bbb; padding: 10px 0; font-style: italic; }

  /* HEARING CARDS */
  .hearing-card { border: 1px solid #eee; margin-bottom: 10px; transition: border-color 0.2s; }
  .hearing-card:hover { border-color: var(--blue); }
  .hearing-zruseno { opacity: 0.6; border-color: #fcc !important; background: #fff5f5; }
  .hearing-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f9f9f9; border-bottom: 1px solid #eee; }
  .hearing-time { font-family: 'Barlow Condensed', sans-serif; font-size: 26px; font-weight: 800; color: var(--blue); }
  .hearing-header-left { display: flex; flex-direction: column; gap: 2px; }
  .hearing-room { font-size: 11px; font-weight: 500; letter-spacing: 0.08em; color: var(--grey); text-transform: uppercase; }
  .hearing-badges { display: flex; gap: 6px; flex-wrap: wrap; }
  .badge { font-size: 10px; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; padding: 4px 10px; border-radius: 2px; }
  .badge-red { background: #fee; color: #c00; border: 1px solid #fcc; }
  .badge-grey { background: #f0f0f0; color: #666; border: 1px solid #ddd; }
  .badge-blue { background: #eef; color: var(--blue); border: 1px solid #ccf; }
  .badge-green { background: #f0fff0; color: #060; border: 1px solid #cfc; }

  .detail-table { width: 100%; border-collapse: collapse; }
  .detail-row td { padding: 9px 16px; font-size: 13px; border-bottom: 1px solid #f5f5f5; }
  .detail-row:last-child td { border-bottom: none; }
  .detail-label { font-size: 10px; font-weight: 500; letter-spacing: 0.12em; text-transform: uppercase; color: var(--grey); width: 160px; }
  .detail-val { color: var(--black); font-weight: 400; }
  .detail-val-case { font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 800; }
  .case-link { color: var(--blue); text-decoration: none; display: inline-flex; align-items: center; gap: 4px; transition: opacity 0.2s; }
  .case-link:hover { opacity: 0.7; }
  .case-link-arrow { font-size: 13px; }

  .app-status { padding: 0 24px; }
  .app-status-loading {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 0; font-size: 11px; font-weight: 500;
    letter-spacing: 0.12em; text-transform: uppercase; color: var(--grey);
  }
  .app-status-loading::before {
    content: ''; display: inline-block; width: 14px; height: 14px;
    border: 2px solid #eee; border-top-color: var(--blue);
    border-radius: 50%; animation: hjspin 0.7s linear infinite;
  }
  .app-status-ready {
    padding: 10px 0; font-size: 11px; font-weight: 500;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: #28c840;
  }
  .app-status-error {
    padding: 10px 0; font-size: 11px; font-weight: 500;
    letter-spacing: 0.12em; text-transform: uppercase; color: #c00;
  }
  .court-search-wrap { position: relative; }
  .app-input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; background: #fafafa; font-size: 13px; font-family: 'Barlow', sans-serif; color: var(--black); transition: border-color 0.2s; }
  .app-input:focus { outline: none; border-color: var(--blue); }
  .app-input::placeholder { color: #bbb; }
  .court-dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: white; border: 1px solid #ddd; border-top: none;
    max-height: 260px; overflow-y: auto;
    z-index: 100; display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }
  .court-dropdown.open { display: block; }
  .court-option {
    padding: 10px 12px; font-size: 13px; cursor: pointer;
    border-bottom: 1px solid #f5f5f5; transition: background 0.1s;
    font-family: 'Barlow', sans-serif;
  }
  .court-option:last-child { border-bottom: none; }
  .court-option:hover, .court-option.active { background: #f0f4ff; color: var(--blue); }
  .court-option-group { padding: 6px 12px; font-size: 9px; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: #bbb; background: #fafafa; border-bottom: 1px solid #f0f0f0; cursor: default; }
  .app-error { background: #fff5f5; border-left: 3px solid #e00; padding: 16px 20px; font-size: 13px; color: #c00; line-height: 1.6; }

  /* FOOTER */
  footer { border-top: 1px solid #eee; padding: 28px 40px; display: flex; justify-content: space-between; font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--grey); }

  @media (max-width: 768px) {
    nav { padding: 16px 20px; }
    .hero { padding-left: 20px; padding-right: 20px; }
    .hero-meta { display: none; }
    .app-wrap { padding: 40px 20px; }
    .app-form { grid-template-columns: 1fr; }
    footer { flex-direction: column; gap: 8px; padding: 20px; }
  }
</style>
</head>
<body>

<nav>
  <div class="nav-logo">Hledaƒç <span>Jedn√°n√≠</span>¬Æ</div>
  <a href="https://b3takar.github.io" class="nav-back">‚Üê Portfolio</a>
</nav>

<!-- HERO -->
<section class="hero">
  <div class="hero-meta">
    <div class="barcode"></div>
    <div class="barcode-label">Hledaƒç Jedn√°n√≠</div>
    <div class="barcode-sub">Verze 2.0<br>2025</div>
  </div>
  <h1 class="hero-name">HLEDAƒå<br>JEDN√ÅN√ç<span class="reg">¬Æ</span></h1>
  <p class="hero-sub">Najdi na≈ô√≠zen√° soudn√≠ jedn√°n√≠ nap≈ô√≠ƒç celou ƒåR ‚Äî rychle, p≈ôehlednƒõ, bez zbyteƒçn√©ho klik√°n√≠.</p>
</section>

<!-- APP -->
<div class="app-wrap">
  <div class="app-box">
    <div class="app-header">
      <span class="app-live-dot"></span>
      <span class="app-live-label">Live ‚Äî infosoud.gov.cz API</span>
    </div>
    <div class="app-form">
      <div class="app-field">
        <label class="app-label">Soud</label>
        <div class="court-search-wrap">
          <input type="text" class="app-input" id="hj-soud-input" placeholder="Zaƒçnƒõte ps√°t n√°zev soudu..." autocomplete="off" oninput="hjFilterCourts()" onfocus="hjShowList()" onblur="hjHideList()">
          <input type="hidden" id="hj-soud">
          <div class="court-dropdown" id="hj-court-list"></div>
        </div>
      </div>
      <div class="app-field">
        <label class="app-label">Poboƒçka</label>
        <select class="app-select" id="hj-pobocka" disabled>
          <option value="">‚Äî Cel√Ω soud ‚Äî</option>
        </select>
      </div>
      <div class="app-field">
        <label class="app-label">Poƒçet dn√≠ dop≈ôedu</label>
        <select class="app-select" id="hj-days">
          <option value="1">1 den</option>
          <option value="2">2 dny</option>
          <option value="3">3 dny</option>
          <option value="5" selected>5 dn√≠</option>
          <option value="7">7 dn√≠</option>
          <option value="14">14 dn√≠</option>
        </select>
      </div>
      <button class="app-btn" id="hj-btn" onclick="hjSearch()">Vyhledat ‚Üí</button>
    </div>
    <div class="app-status" id="hj-status"></div>
    <div class="app-results" id="hj-results">
      <div class="app-empty">Vyberte soud a kliknƒõte na Vyhledat.</div>
    </div>
  </div>
</div>

<footer>
  <span>¬© 2025 Oskar Shindler</span>
  <span>Data: infosoud.gov.cz</span>
  <span>Czech Republic</span>
</footer>

<script>
(function() {
  const API = 'https://hledac-proxy.otakar-84f.workers.dev';
  let currentSins = [];
  let currentBranchMap = {};

  let allCourts = [];
  let hideTimeout = null;

  // Load courts on init
  async function hjInit() {
    try {
      const [r1, r2] = await Promise.all([
        fetch(`${API}/organizace/lov`),
        fetch(`${API}/organizace/podrizene/lov`)
      ]);
      const krajske = await r1.json();
      const okresni = await r2.json();
      const hlavni = krajske.sort((a,b) => a.nazev.localeCompare(b.nazev, 'cs'));
      const ostatni = okresni.sort((a,b) => a.nazev.localeCompare(b.nazev, 'cs'));
      allCourts = [
        ...hlavni.map(c => ({ ...c, group: 'Krajsk√© a vrchn√≠ soudy' })),
        ...ostatni.map(c => ({ ...c, group: 'Okresn√≠ a obvodn√≠ soudy' }))
      ];
      document.getElementById('hj-soud-input').placeholder = 'Zaƒçnƒõte ps√°t n√°zev soudu...';
    } catch(e) {
      document.getElementById('hj-soud-input').placeholder = 'Chyba naƒç√≠t√°n√≠ soud≈Ø';
    }
  }

  function renderCourtList(filtered) {
    const list = document.getElementById('hj-court-list');
    if (filtered.length === 0) {
      list.innerHTML = '<div class="court-option" style="color:#bbb">≈Ω√°dn√Ω soud nenalezen</div>';
      return;
    }
    let html = '';
    let lastGroup = null;
    filtered.forEach(c => {
      if (c.group !== lastGroup) {
        html += `<div class="court-option-group">${c.group}</div>`;
        lastGroup = c.group;
      }
      html += `<div class="court-option" data-kod="${c.kod}" data-nazev="${c.nazev}" onmousedown="hjSelectCourt('${c.kod}','${c.nazev.replace(/'/g, "\\'")}')">${c.nazev}</div>`;
    });
    list.innerHTML = html;
  }

  window.hjFilterCourts = function() {
    const q = document.getElementById('hj-soud-input').value.toLowerCase().trim();
    // Clear previous selection
    document.getElementById('hj-soud').value = '';
    const list = document.getElementById('hj-court-list');
    list.classList.add('open');
    if (q.length === 0) {
      renderCourtList(allCourts);
      return;
    }
    const filtered = allCourts.filter(c => c.nazev.toLowerCase().includes(q));
    renderCourtList(filtered);
  };

  window.hjShowList = function() {
    clearTimeout(hideTimeout);
    const list = document.getElementById('hj-court-list');
    const q = document.getElementById('hj-soud-input').value.toLowerCase().trim();
    renderCourtList(q ? allCourts.filter(c => c.nazev.toLowerCase().includes(q)) : allCourts);
    list.classList.add('open');
  };

  window.hjHideList = function() {
    hideTimeout = setTimeout(() => {
      document.getElementById('hj-court-list').classList.remove('open');
    }, 200);
  };

  window.hjSelectCourt = function(kod, nazev) {
    document.getElementById('hj-soud-input').value = nazev;
    document.getElementById('hj-soud').value = kod;
    document.getElementById('hj-court-list').classList.remove('open');
    hjOnCourtChange();
  };

  // Load sins when court is selected
  // Branch detection rules per court
  const BRANCH_RULES = {
    'KSSCEUL': { // KS √öst√≠ nad Labem
      detect: (kod) => /pob\..*liberec/i.test(kod) ? 'Poboƒçka Liberec' : '√öst√≠ nad Labem',
      branches: ['√öst√≠ nad Labem', 'Poboƒçka Liberec']
    },
    'KSSEMOS': { // KS Ostrava
      detect: (kod) => /budova\s+[AB]/i.test(kod) ? 'Ostrava' : 'Poboƒçka Olomouc',
      branches: ['Ostrava', 'Poboƒçka Olomouc']
    },
    'KSJICCB': { // KS ƒåesk√© Budƒõjovice
      detect: (kod) => /pob\..*t√°bor|t√°bor/i.test(kod) ? 'Poboƒçka T√°bor' : 'ƒåesk√© Budƒõjovice',
      branches: ['ƒåesk√© Budƒõjovice', 'Poboƒçka T√°bor']
    },
    'KSVYCHK': { // KS Hradec Kr√°lov√©
      detect: (kod) => /PCE/i.test(kod) ? 'Poboƒçka Pardubice' : 'Hradec Kr√°lov√©',
      branches: ['Hradec Kr√°lov√©', 'Poboƒçka Pardubice']
    },
    'KSJIMBM': { // KS Brno
      detect: (kod) => {
        if (/jihlava/i.test(kod)) return 'Poboƒçka Jihlava';
        if (/zl√≠n/i.test(kod)) return 'Poboƒçka Zl√≠n';
        return 'Brno';
      },
      branches: ['Brno', 'Poboƒçka Jihlava', 'Poboƒçka Zl√≠n']
    },
  };

  window.hjOnCourtChange = async function() {
    const courtId = document.getElementById('hj-soud').value;
    const statusEl = document.getElementById('hj-status');
    const btn = document.getElementById('hj-btn');
    const pobockaSel = document.getElementById('hj-pobocka');
    currentSins = [];
    currentBranchMap = {};

    if (!courtId) {
      statusEl.innerHTML = '';
      pobockaSel.innerHTML = '<option value="">‚Äî Cel√Ω soud ‚Äî</option>';
      pobockaSel.disabled = true;
      return;
    }

    statusEl.innerHTML = '<div class="app-status-loading">Naƒç√≠t√°m jednac√≠ s√≠nƒõ...</div>';
    btn.disabled = true;

    try {
      const res = await fetch(`${API}/organizace/lovkod/jednaci-sin?idOrganizace=${courtId}`);
      const data = await res.json();

      // Deduplicate
      const roomMap = new Map();
      data.forEach(s => {
        const normalized = s.kod.replace(/\s+/g, ' ').trim();
        const roomNum = normalized.match(/^(\d+)/)?.[1] || normalized;
        const existing = roomMap.get(roomNum);
        if (!existing || normalized.length > existing.length) roomMap.set(roomNum, normalized);
      });
      currentSins = [...roomMap.values()];

      // Build branch map if court has branches
      const rule = BRANCH_RULES[courtId];
      pobockaSel.innerHTML = '<option value="">‚Äî Cel√Ω soud ‚Äî</option>';
      if (rule) {
        // Map each sin to its branch
        currentSins.forEach(sin => {
          currentBranchMap[sin] = rule.detect(sin);
        });
        // Populate pobocka dropdown
        rule.branches.forEach(branch => {
          const count = Object.values(currentBranchMap).filter(b => b === branch).length;
          if (count > 0) {
            const o = document.createElement('option');
            o.value = branch;
            o.textContent = branch;
            pobockaSel.appendChild(o);
          }
        });
        pobockaSel.disabled = false;
      } else {
        pobockaSel.disabled = true;
      }

      statusEl.innerHTML = `<div class="app-status-ready">‚úì Naƒçteno ${currentSins.length} jednac√≠ch s√≠n√≠</div>`;
      setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
    } catch(e) {
      currentSins = [];
      statusEl.innerHTML = '<div class="app-status-error">Chyba naƒç√≠t√°n√≠ s√≠n√≠</div>';
    } finally {
      btn.disabled = false;
    }
  };

  function getDates(days) {
    const dates = [];
    const today = new Date();
    for (let i = 0; i < parseInt(days); i++) {
      const d = new Date(today); d.setDate(today.getDate() + i);
      dates.push(d.toISOString().split('T')[0]);
    }
    return dates;
  }

  function fmtDate(iso) {
    const [y,m,d] = iso.split('-');
    const dn = ['Nedƒõle','Pondƒõl√≠','√öter√Ω','St≈ôeda','ƒåtvrtek','P√°tek','Sobota'][new Date(iso).getDay()];
    return `${dn} ${parseInt(d)}.${parseInt(m)}.${y}`;
  }

  window.hjSearch = async function() {
    const courtId = document.getElementById('hj-soud').value;
    const days = document.getElementById('hj-days').value;
    const resultsEl = document.getElementById('hj-results');
    const statusEl = document.getElementById('hj-status');
    const btn = document.getElementById('hj-btn');

    if (!courtId) { resultsEl.innerHTML = '<div class="app-error">Pros√≠m vyberte soud.</div>'; return; }
    if (currentSins.length === 0) { resultsEl.innerHTML = '<div class="app-error">Poƒçkejte pros√≠m na naƒçten√≠ s√≠n√≠.</div>'; return; }

    btn.disabled = true;
    btn.textContent = 'Naƒç√≠t√°m...';
    resultsEl.innerHTML = '<div class="app-spinner">Naƒç√≠t√°m jedn√°n√≠ ze v≈°ech s√≠n√≠</div>';

    const dates = getDates(days);

    try {
      // Filter sins by selected branch
      const selectedBranch = document.getElementById('hj-pobocka').value;
      let filteredSins = currentSins.length > 0 ? currentSins : [null];
      if (selectedBranch && Object.keys(currentBranchMap).length > 0) {
        filteredSins = filteredSins.filter(s => currentBranchMap[s] === selectedBranch);
      }

      // Fetch all sins x all dates in parallel
      const fetches = [];
      for (const date of dates) {
        for (const sin of filteredSins) {
          const payload = { druhOrganizace: courtId, datumJednani: date, typHledani: 'JEDNANI', jednaciSin: sin };
          fetches.push(
            fetch(`${API}/jednani/vyhledej`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }).then(r => r.ok ? r.json() : null).then(data => ({ date, sin, data }))
          );
        }
      }

      const rawResults = await Promise.all(fetches);

      // Group by date
      const byDate = {};
      for (const date of dates) byDate[date] = [];
      rawResults.forEach(({ date, sin, data }) => {
        if (!data) return;
        const udalosti = Array.isArray(data) ? data.flatMap(d => d.udalosti || []) : (data.udalosti || []);
        // Attach sin to each udalost so we know where it takes place
        udalosti.forEach(u => { if (!u.jednaciSin) u.jednaciSin = sin; });
        byDate[date].push(...udalosti);
      });

      let totalHearings = 0;
      let html = '';

      for (const date of dates) {
        const udalosti = byDate[date];
        udalosti.sort((a,b) => (a.cas || '').localeCompare(b.cas || ''));

        // Deduplicate by time + case
        const seen = new Set();
        const unique = udalosti.filter(u => {
          const key = `${u.cas}-${u.cislo}-${u.druh}-${u.rocnik}`;
          if (seen.has(key)) return false;
          seen.add(key); return true;
        });

        totalHearings += unique.length;

        html += `<div class="app-day-block">
          <div class="app-day-title">
            <span>${fmtDate(date)}</span>
            <span class="app-day-count">${unique.length} jedn√°n√≠</span>
          </div>`;

        if (unique.length === 0) {
          html += '<div class="app-no-hearings">≈Ω√°dn√° jedn√°n√≠ napl√°nov√°na.</div>';
        } else {
          unique.forEach(u => {
            const caseNum = [u.cislo, u.druh, u.rocnik].filter(x => x != null).join(' ');
            const zruseno = u.jednaniZruseno;
            const neverejne = u.neverejneJednani;
            let badges = '';
            if (zruseno) badges += '<span class="badge badge-red">Zru≈°eno</span>';
            badges += neverejne ? '<span class="badge badge-grey">Neve≈ôejn√©</span>' : '<span class="badge badge-green">Ve≈ôejn√©</span>';
            const infoSoudUrl = (u.cislo && u.druh && u.bcVec && u.rocnik)
              ? `https://infosoud.gov.cz/InfoSoud/detail-rizeni?typOrganizace=VSECHNY_KRAJE&druhOrganizace=${courtId}&cisloSenatu=${u.cislo}&druhVeci=${u.druh}&bcVec=${u.bcVec}&rocnik=${u.rocnik}`
              : null;
            const caseLink = infoSoudUrl
              ? `<a href="${infoSoudUrl}" target="_blank" class="case-link">${caseNum} <span class="case-link-arrow">‚Üó</span></a>`
              : (caseNum || '‚Äî');
            let rows = `<tr class="detail-row"><td class="detail-label">Spisov√° znaƒçka</td><td class="detail-val detail-val-case">${caseLink}</td></tr>`;
            if (u.resitel) rows += `<tr class="detail-row"><td class="detail-label">Soudce</td><td class="detail-val">${u.resitel}</td></tr>`;
            if (u.druhJednani) rows += `<tr class="detail-row"><td class="detail-label">Druh jedn√°n√≠</td><td class="detail-val">${u.druhJednani}</td></tr>`;
            if (u.predmetJednani) rows += `<tr class="detail-row"><td class="detail-label">P≈ôedmƒõt</td><td class="detail-val">${u.predmetJednani}</td></tr>`;
            rows += `<tr class="detail-row"><td class="detail-label">Jednac√≠ s√≠≈à</td><td class="detail-val">${u.jednaciSin || '‚Äî'}</td></tr>`;
            if (u.vysledek) rows += `<tr class="detail-row"><td class="detail-label">V√Ωsledek</td><td class="detail-val">${u.vysledek}</td></tr>`;
            if (u.datumZapisuVysledku) rows += `<tr class="detail-row"><td class="detail-label">Datum z√°pisu</td><td class="detail-val">${u.datumZapisuVysledku}</td></tr>`;
            html += `<div class="hearing-card ${zruseno ? 'hearing-zruseno' : ''}">
              <div class="hearing-header">
                <div class="hearing-header-left">
                  <span class="hearing-time">${u.cas || '‚Äî'}</span>
                  <span class="hearing-room">üìç ${u.jednaciSin || '‚Äî'}</span>
                </div>
                <div class="hearing-badges">${badges}</div>
              </div>
              <table class="detail-table">${rows}</table>
            </div>`;
          });
        }
        html += '</div>';
      }

      const summary = `<div class="app-summary">Celkem ${totalHearings} jedn√°n√≠ za ${days} dn√≠</div>`;
      resultsEl.innerHTML = totalHearings === 0
        ? '<div class="app-empty">≈Ω√°dn√° jedn√°n√≠ nenalezena.</div>'
        : summary + html;

    } catch(e) {
      resultsEl.innerHTML = `<div class="app-error">Nepoda≈ôilo se naƒç√≠st data.<br><small>${e.message}</small></div>`;
    } finally {
      btn.disabled = false;
      btn.textContent = 'Vyhledat ‚Üí';
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', hjInit);
  } else {
    hjInit();
  }
})();
</script>
</body>
</html>
